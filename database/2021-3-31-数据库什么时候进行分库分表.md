# SQL在什么情况下要分表、分库？

## 数据切分

* 当单表的数据量达到1000W或100G以后，由于查询维度较多，即使添加从库、优化索引，做很多操作时性能仍下降严重。此时就要考虑对其进行切分了，切分的目的就在于减少数据库的负担，缩短查询时间。
* 数据库分布式核心内容无非就是数据切分（Sharding），以及切分后对数据的定位、整合。
* 数据切分就是将数据分散存储到多个数据库中，使得单一数据库中的数据量变小，通过扩充主机的数量缓解单一数据库的性能问题，从而达到提升数据库操作性能的目的。

## 数据切分根据其切分类型，可以分为两种方式：垂直（纵向）切分和水平（横向）切分。

### 垂直（纵向）切分
* 垂直切分常见有垂直分库和垂直分表两种。
* 垂直分库就是**根据业务耦合性，将关联度低的不同表存储在不同的数据库**。做法与大系统拆分为多个小系统类似，按业务分类进行独立划分。与"微服务治理"的做法相似，每个微服务使用单独的一个数据库。
* 垂直分表是基于数据库中的"列"进行，某个表字段较多，可以新建一张扩展表，将不经常用或字段长度较大的字段拆分出去到扩展表中。

#### 垂直切分的优点
* 解决业务系统层面的耦合，业务清晰
* 与微服务的治理类似，也能对不同业务的数据进行分级管理、维护、监控、扩展等
* 高并发场景下，垂直切分一定程度的提升IO、数据库连接数、单机硬件资源的瓶颈

#### 缺点
* 部分表无法join，只能通过接口聚合方式解决，提升了开发的复杂度
* 布式事务处理复杂
* 依然存在单表数据量过大的问题（需要水平切分）

### 水平（横向）切分
* 当一个应用难以再细粒度的垂直切分，或切分后数据量行数巨大，存在单库读写、存储性能瓶颈，这时候就需要进行水平切分了。
* 水平切分分为**库内分表和分库分表**，是根据表内数据内在的逻辑关系，将同一个表按不同的条件分散到多个数据库或多个表中，每个表中只包含一部分数据，从而使得单个表的数据量变小，达到分布式的效果

#### 水平切分的优点
* 不存在单库数据量过大、高并发的性能瓶颈，提升系统稳定性和负载能力
* 应用端改造较小，不需要拆分业务模块

#### 缺点
* 跨分片的事务一致性难以保证
* 跨库的join关联查询性能较差
* 数据多次扩展难度和维护量极大


##### 几种典型的分片规则
##### 根据数值范围
* 按照时间区间或ID区间来切分。例如：按日期将不同月甚至是日的数据分散到不同的库中；
* 优点：1.单表大小可控，2.天然便于水平扩展，后期如果想对整个分片集群扩容时，只需要添加节点即可，无需对其他分片的数据进行迁移，3.使用分片字段进行范围查找时，连续分片可快速定位分片进行快速查询，有效避免跨分片查询的问题。
* 缺点：热点数据成为性能瓶颈。连续分片可能存在数据热点，例如按时间字段分片，有些分片存储最近时间段内的数据，可能会被频繁的读写，而有些分片存储的历史数据，则很少被查询

##### 根据数值取模
* 一般采用hash取模mod的切分方式。例如。根据userid等将数据切分到4个库中
* 优点：数据分片相对比较均匀，不容易出现热点和并发访问的瓶颈
* 缺点：1.后期分片集群扩容时，需要迁移旧的数据（使用一致性hash算法能较好的避免这个问题），2.容易面临跨分片查询的复杂问题。



参考问题：https://www.zhihu.com/question/446688267/answer/1753142269
