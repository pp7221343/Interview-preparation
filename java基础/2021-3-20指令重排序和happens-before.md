# 指令重排序和happens-before

## 重排序

* 计算机在执行程序时，为了提高性能，编译器和处理器常常会对指令做重排

## 为什么指令重排序可以提高性能

* 指令重排对于提高CPU处理性能十分必要。
每一个指令都会包含多个步骤，每个步骤可能使用不同的硬件,如果不存在数据依赖性，则可以乱序执行，以提高cpu性能，减少中断。


## 指令重排一般分为以下三种

* 编译器优化重排
    编译器在**不改变单线程程序语义**的前提下，可以重新安排语句的执行顺序
    
* 指令并行重排
    现代处理器采用了指令级并行技术来将多条指令重叠执行。如果**不存在数据依赖性**，处理器可以改变语句对应的机器指令的执行顺序

* 内存系统重排
    由于处理器使用缓存和读写缓存冲区，这使得加载(load)和存储(store)操作看上去可能是在乱序执行，因为三级缓存的存在，导致内存与缓存的数据同步存在时间差
    
* **指令重排可以保证串行语义一致，但是没有义务保证多线程间的语义也一致**


## happens-before

* JMM提供了happens-before规则（JSR-133规范），满足了程序员的需求——简单易懂，并且提供了足够强的内存可见性保证


* happens-before关系的定义如下：
   1. 如果一个操作happens-before另一个操作，那么第一个操作的执行结果将对第二个操作可见，而且第一个操作的执行顺序排在第二个操作之前。 
   2. 两个操作之间存在happens-before关系，并不意味着Java平台的具体实现必须要按照happens-before关系指定的顺序来执行。
       如果重排序之后的执行结果，与按happens-before关系来执行的结果一致，那么JMM也允许这样的重排序
